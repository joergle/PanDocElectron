<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>PanDoc Electron</title>
    <!--link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet"-->
    <!-- JQUERY MOBILE Integration -->
    <link href="css/app.css" rel="stylesheet" />
    <!--
     <link href="css/jquery.mobile.icons.min.css" rel="stylesheet" />
    <link href="css/jquery.mobile.structure-1.4.5.min.css" rel="stylesheet" />
    <!script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    -->
    <link href="css/main.css" rel="stylesheet" />
    <script src="js/showhide.js"></script>
    <script src="js/pathfiles.js"></script>
    <script src="js/writedom.js"></script>
    <script src="js/opsysdetect.js"></script>
    <script src="js/cmdpandoc.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <h1>
            <a href="javascript:openBrowserURL('http://pandoc.org/try')"><img src="css/images/icons-png/info-black.png"></a>
            <pandoc class="pandocblue">PanDoc</pandoc> Electron
          </h1>
        </div>
        <div class="col-md-6" style="text-align:center;display:none">
         <input type="text" id="pandocprogress" size="50">
        </div>
      </div>
      <div class="row">
        <div align="center">
          <button class="bluebutton" id="loadConfig"  onclick="loadConfig('default.cfg');">Load Config</button>
          <button class="bluebutton" id="saveConfig"  onclick="saveConfig('default.cfg');">Save Config</button>
          <hr/>
        </div>
        <div align="center">
          <button  id="bConvert"  onclick="setPage(this.id);">Convert</button>
          <button  id="bEditor"  onclick="setPage(this.id);">Editor</button>
          <button  id="bNew"  onclick="setPage(this.id);">New</button>
          <button  id="bWebInput"  onclick="setPage(this.id);">Web-Input</button>
          <button  id="bBibliography"  onclick="setPage(this.id);">Bibliography</button>
          <button  id="bDirectories"  onclick="setPage(this.id);">Directories</button>
          <button  id="bTemplates"  onclick="setPage(this.id);">Templates</button>
          <hr/>
        </div>
      </div>
      <div class="mainpage" id="divconfig">
        <div class="apptab" id="bConvertPage">
          <table border="0"  cellspacing="30" class="buttonsnovice">
            <tr>
              <td>
                <button class="btn btn-primary btn-xs"  id="openFile"  onclick="openInputFile('');">Input File</button>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <select id="inputFORMAT" onchange="changedInFormat(this.value)">
                  <option value="markdown" selected="selected">Markdown (pandoc)</option>
                  <option value="mediawiki">MediaWiki</option>
                  <option value="html">HTML</option>
                  <option value="latex">LaTeX</option>
                  <option value="pdf">PDF Input for AudioSlides Output</option>
                  <option value="docbook">DocBook</option>
                  <option value="haddock">Haddock markup</option>
                  <option value="markdown_strict">Markdown (strict)</option>
                  <option value="markdown_phpextra">Markdown (PHP Markdown Extra)</option>
                  <option value="markdown_github">Markdown (GitHub)</option>
                  <option value="markdown_mmd">MultiMarkdown</option>
                  <option value="opml">OPML</option>
                  <option value="org">Org Mode</option>
                  <option value="rst">reStructuredText</option>
                  <option value="textile">Textile</option>
                  <option value="t2t">Txt2Tags</option>
                </select>
                <button class="bluebutton" id="convertFILE"  onclick="convertFile();" >Convert File</button>
                <div id="selectInputFORMAT" style="display: none">markdown</div>
              </td>
            </tr>
            <tr>
              <td align="right">
                <b>Input File:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="inputFILE"></tt>
              </td>
            </tr>
            <tr><!-- outputFILE -->
              <td align="right">
                <b>Output Format:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <select id="outputFORMAT" onchange="changedOutFormat(this.value)">
                  <option value="html">HTML</option>
                  <option value="html5">HTML 5</option>
                  <option value="latex">LaTeX</option>
                  <option value="markdown">Markdown (pandoc)</option>
                  <option value="mediawiki">MediaWiki</option>
                  <option value="beamer">LaTeX Beamer</option>
                  <option value="reveal" selected="selected">RevealJS</option>
                  <option value="audioslides">AudioSlides for PDF Input</option>
                  <option value="dzslides">DZSlides</option>
                  <option value="odt">ODT-File</option>
                  <option value="odt2col">ODT-File - 2 Cols</option>
                  <option value="docx">DOCX-File</option>
                  <option value="docx2col">DOCX-File - 2 Cols</option>
                  <option value="asciidoc">AsciiDoc</option>
                  <option value="context">ConTeXt</option>
                  <option value="docbook">DocBook</option>
                  <option value="dokuwiki">DokuWiki</option>
                  <option value="man">Groff man</option>
                  <option value="icml">ICML</option>
                  <option value="markdown_strict">Markdown (strict)</option>
                  <option value="markdown_phpextra">Markdown (PHP Markdown Extra)</option>
                  <option value="markdown_github">Markdown (GitHub)</option>
                  <option value="markdown_mmd">MultiMarkdown</option>
                  <option value="rst">reStructuredText</option>
                  <option value="textile">Textile</option>
                  <option value="org">Org Mode</option>
                  <option value="opendocument">OpenDocument</option>
                  <option value="opml">OPML</option>
                  <option value="rtf">RTF</option>
                  <option value="S5">S5</option>
                  <option value="slideous">Slideous</option>
                  <option value="slidy">Slidy</option>
                  <option value="texinfo">Texinfo</option>
                </select>
                <div id="selectOutputFORMAT"  style="display: none">reveal</div>
                <div id="divSlideCount" hidden="hidden">AudioSlide Count <input type="text" id="slidecount" value="16" size="3"></div>
              </td>
            </tr>
            <tr><!-- outputFILE -->
              <td align="right">
                <b>Output File:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="outputFILE"></tt>
              </td>
            </tr>
            <tr><!-- outputFILE -->
              <td align="right">
                <b>Title:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="outputTITLE"></tt>
                <input TYPE="text" size="75" id="outputTITLE" value="My Title"/>
              </td>
            </tr>
            <tr><!-- outputFILE -->
              <td align="right">
                <b>Author:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <input TYPE="text" size="40" id="outputAUTHOR" value="My Name"/>
              </td>
            </tr>
          </table>
          <hr/>
        </div>
        <div class="apptab" id="bNewPage" hidden="hidden">
          <h3>
            New-Project:
            <input type="checkbox" name="checkWebInput" id="checkWebInput" onclick="toggleCheck('tablenew',this.checked)"  hidden="hidden">
          </h3>
          <table border="0"  cellspacing="30" id="tablenew" class="buttonsnew" >
            <tr>
              <td align="right">
                <b>Project Name:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <input type="text" size="35" id="inputNEWPROJECT" value="myproject" onchange="setInput4Project(this.id,'inputNEWFILE')">
                <button class="btn btn-primary btn-xs"  id="createNewProjectBTN"  onclick="createProject();">Create Project</button>
              </td>
            </tr>
            <tr>
              <td align="right">
                <b>New File:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="inputNEWFILE"></tt>
              </td>
            </tr>
          </table>
          <hr/>
        </div>
        <div class="apptab" id="bWebInputPage" hidden="hidden">
          <h3>
            Web-Input:
            <input type="checkbox" name="checkWebInput" id="checkWebInput" onclick="toggleCheck('tableweb',this.checked)"  hidden="hidden">
          </h3>
          <table border="0"  cellspacing="30" id="tableweb" class="buttonsweb" >
            <tr>
              <td align="right">
                <b>Project Name:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <input type="text" size="35" id="inputWEBPROJECT" value="mywebfile" onchange="setInput4Project(this.id,'downloadWebFILE')">
              </td>
            </tr>
            <tr>
              <td align="right">
                <b>Download File:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="downloadWebFILE"></tt>
              </td>
            </tr>
            <tr>
              <td align="right">
                <button class="btn btn-primary btn-xs"  id="downloadFile"  onclick="downloadInputFile('projects');">Download File</button>
              </td>
              <td>
                  &nbsp;
              </td>
              <td>
                  <input type="text" size="55" id="inputURL" value="http://www.gnu.org/software/make/" >
              </td>
            </tr>
          </table>
          <hr/>
        </div>
        <div class="apptab" id="bBibliographyPage" hidden="hidden">
          <h3>
            Bibiography:
            <input type="checkbox" name="checkCitation" id="checkCitation" onclick="toggleCheck('tablecitation',this.checked)"  hidden="hidden">
          </h3>
          <table border="0"  cellspacing="30" id="tablecitation" class="buttonscitation" >
            <tr><!-- bibFILE -->
              <td>
                  <button class="btn btn-primary btn-xs"  id="openBIBFile"  onclick="openBIBFile('data');">BibTeX Citation</button>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt>BibTeX-Format</tt>
              </td>
            </tr>
            <tr><!-- bibFILE -->
              <td>
                <b>&nbsp;</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="bibFILE"></tt>
              </td>
            </tr>
            <tr><!-- cslFILE -->
              <td>
                <button class="btn btn-primary btn-xs"  id="openCSLFile"  onclick="openCSLFile('csl');">CSL-File</button>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt>Citation Style</tt>
              </td>
            </tr>
            <tr><!-- cslFILE -->
              <td>
                <b>&nbsp;</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="cslFILE"></tt>
              </td>
            </tr>
          </table>
          <hr/>
        </div>
        <div class="apptab" id="bTemplatesPage"  hidden="hidden">
          <h3>
            Templates:
            <input type="checkbox" name="checkTemplates" id="checkTemplates" onclick="toggleCheck('tabletemplates',this.checked)"  hidden="hidden">
          </h3>
          <table border="0"  cellspacing="30" id="tabletemplates" class="buttonstemplate" >
          </table>
          <hr/>
        </div>
        <div class="apptab" id="bDirectoriesPage"  hidden="hidden">
          <h3>
            Directories:
            <input type="checkbox" name="checkFolders" id="checkFolders" onclick="toggleCheck('tablefolders',this.checked)"  hidden="hidden">
          </h3>
          <table border="0"  cellspacing="30" id="tablefolders" class="buttonstemplate" >
            <tr>
              <td>
                <button class="btn btn-default"  id="defDIRmainDIR"  onclick="openDirectory('projectmainDIR',document.getElementById('projectmainDIR').innerHTML);">Main Folder</button>
              </td>
              <td>
                  &nbsp;
              </td>
              <td>
                  <tt id="projectmainDIR"></tt>
              </td>
            </tr>
          </table>
          <hr/>
        </div>
        <div class="apptab" id="bEditorPage"  hidden="hidden">
          <h3>
            Input Editor:
            <input type="checkbox" name="checkEditor" id="checkEditor" onclick="toggleCheck('inputEDITOR',this.checked)" hidden="hidden"> --
            <button onclick="saveEditorContent()"> Save </button>
          </h3>
          <textarea id="inputEDITOR" rows="15" ></textarea>
          <textarea id="inputLOOP" maxlength="3000" rows="15" ></textarea>
          <hr/>
        </div>
        <div class="divcommand">
          <pre id="command"></pre>
        </div>
    </div>
    <footer>
     <p class="version">PanDoc Electron - GUI <span id="version">0.4</span> - Engelbert Niehaus</p>
     <p><b><a href="javascript:openBrowserURL('http://pandoc.org/')">PanDoc</a></b> by <a href="javascript:openBrowserURL('http://johnmacfarlane.net/')">John MacFarlane</a>
       PanDoc Electron uses Node.js <script>document.write(process.versions.node)</script>,
       Chromium <script>document.write(process.versions.chrome)</script>,
       and Electron <script>document.write(process.versions.electron)</script>.
     </p>
    </footer>
    <!-- All of the Node.js APIs are available in this renderer process. -->
<br />
<script>
var remote  = require('remote');
const fs    = require('fs');
var app     = remote.require('app');
var dialog  = remote.require('dialog');
var vPathSeparator = "/";

function openBrowserURL(pURL) {
  const {shell} = require('electron');
  shell.openExternal(pURL);
}
function openInputFile (pPath) {
  pPath = getProjectDir(pPath);
  openFile("inputFILE","inputEDITOR",pPath);
}
function openREFFile (pPath) {
  pPath = getSoftwareDir(pPath);
  openFile("refFILE","",pPath)
}
function openBIBFile (pPath) {
  //pPath = getProjectDir(pPath);
  var vSep = getPathSeparator();
  pPath = getSoftwareDir("bib"+vSep+pPath);
  openFile("bibFILE","",pPath)
}
function openCSLFile (pPath) {
  var vSep = getPathSeparator();
  pPath = getSoftwareDir("bib"+vSep+pPath);
  openFile("cslFILE","",pPath)
}
function openTPLFile (pPath) {
  pPath = getSoftwareDir(pPath);
  openFile("tplFILE","",pPath)
}
function downloadInputFile(pPath) {
  //alert("Download Input File and Convert Source File to MarkDown");
  var vPath = getProjectDir(getValueDOM("inputWEBPROJECT"));
  makedirpath(vPath);
  //alert("URL: "+getValueDOM("inputURL")+"\nDownload File: "+getValueDOM("downloadWebFILE")+"\nWeb Project: "+getValueDOM("inputWEBPROJECT"));

  var vCommand ="pandoc -s -r html "+getValueDOM("inputURL")+" -o "+getValueDOM("downloadWebFILE");
  console.log(vCommand);
  var vAnswer = true;
  if (checkFileExists(getValueDOM("downloadWebFILE"))) {
    vAnswer = confirm("Warning Download will overwrite existing File!")
  };
  if (vAnswer) {
    runShellCommand(vCommand);
    vInputFile = getValueDOM("downloadWebFILE");
    copyFile2Editor ("inputEDITOR",vInputFile);
    write2innerHTML("inputFILE",vInputFile);
    alert("Download URL: "+getValueDOM("inputURL")+"\nto Web Project: "+getValueDOM("inputWEBPROJECT"));
  }
};
function changedWebInput(pChecked) {
  //alert("Changed Web Input");
  };
function changedInFormat (pInputFORMAT) {
  //alert("Changed Input Format to "+pInputFORMAT);
  //setInput4Project('inputNEWPROJECT','inputNEWFILE');
  switch (pInputFORMAT) {
    case "pdf":
        // PDF as Input implies audioslides as outputFORMAT
        setOutputFormat("audioslides");
        setInput4Project("inputNEWPROJECT",'inputNEWFILE');
        break;
    case "myformat":
        // handle case
        break;
    default:
      // Default Output Format
      setInput4Project("inputNEWPROJECT",'inputNEWFILE');
  } //end switch
  write2innerHTML("selectInputFORMAT",pInputFORMAT);
}
function autoSelectInputFormat() {
  var vFile = getValueDOM("inputFILE");
  var vExt = getExtensionOfFilename(vFile);
  if (vExt2Format[vExt]) {
    write2value("inputFORMAT",vExt2Format[vExt]);
  };
  if (vExt == "pdf") {
    setOutputFormat("audioslides");
  }
}
function setInputFormat(pInputFORMAT) {
  write2value("inputFORMAT",pInputFORMAT);
};
function changedOutFormat (pOutputFORMAT) {
  //alert("Changed Output Format to "+pOutputFORMAT);
  var vInputFile= getValueDOM("inputFILE");
  if ((!vInputFile) || (vInputFile == "")) {
    alert("Input File is undefined! Please select File\n  changetOutFormat()-Call:377");
  } else {
    //alert("changedOutFormat() vInputFile="+vInputFile);
    var vOutFile = createOutputFile(vInputFile,pOutputFORMAT);
    write2innerHTML("outputFILE",vOutFile);
    switch (pOutputFORMAT) {
      case "audioslides":
          // PDF as Input implies audioslides as outputFORMAT
          setInputFormat("pdf");
          break;
      case "myformat":
          // handle case
          break;
      default:
        // Default Output Format
    } //end switch
  };
  write2value("selectOutputFORMAT",pOutputFORMAT);
  visibleAudioSlideCount(pOutputFORMAT);
};
function setOutputFormat(pOutputFORMAT) {
  write2value("outputFORMAT",pOutputFORMAT);
  var vInputFile = getValueDOM("inputFILE");
  var vOutFile   = createOutputFile(vInputFile,pOutputFORMAT);
  write2innerHTML("outputFILE",vOutFile);
  visibleAudioSlideCount(pOutputFORMAT);
};

function visibleAudioSlideCount(pOutputFORMAT) {
  if (pOutputFORMAT == "audioslides") {
    showElement("divSlideCount");
    alert("Input File must be PDF!");
  } else {
    hideElement("divSlideCount");
  };
}
function saveEditorContent() {
  var vInputFile = getValueDOM("inputFILE");
  if (vInputFile=="") {
    alert("Error: Input Filename is not defined!");
  } else {
    alert("Input File saved!\n"+vInputFile);
  }
}
function createProject() {
  var vSep = getPathSeparator();
  var vName = getValueDOM("inputNEWPROJECT");
  var vPath = getValueDOM("projectmainDIR")+vSep+vName;
  var vInFormat = getValueDOM("inputFORMAT");
  var vExt = vExtHash[vInFormat];
  // vFilename is the new Input Filename for the new project
  var vFilename = vPath+vSep+vName+"."+vExt;
  // vFile
  if (confirm("Do you want to create the following project?\nProject Folder: "+vName+"/\nFilename: "+vName+"."+vExt)) {
    makedirpath(vPath);
    //openFile (vFilenameID,"inputEDITOR",pPath)
    var vDir = __dirname+vSep+"tpl"+vSep+"DEFAULT"+vSep;
    // vDefaultFile: Copy from this default Source File for new Project
    var vDefaultFile = vDir + "md" + vSep +"default.md";
    var vInFormat = getValueDOM("inputFORMAT");
    switch (vInFormat) {
      case "md":
        //alert("MD Create Project createProject():436:index.html");
        vDefaultFile = vDir + vInFormat + vSep +"default."+vInFormat;
        copyFile(vDefaultFile,vFilename);
        break;
      case "mediawiki":
        //alert("WIKI Create Project createProject():441:index.html");
        vDefaultFile = vDir + "wiki" + vSep +"default.wiki";
        copyFile(vDefaultFile,vFilename);
        break;
      case "pdf":
          //alert("MD Create Project createProject():436:index.html");
          vDefaultFile = vDir + vInFormat + vSep +"default."+vInFormat;
          copyFile(vDefaultFile,vFilename);
          break;
      default:
        //alert("["+vInFormat+"] Create Project createProject():441:index.html");
        vDefaultFile = vDir + "md" + vSep +"default.md";
        runShellCommand("pandoc -f markdown -t "+vInFormat+" "+vDefaultFile+" -o "+vFilename);
    };
    makeProjectDirs(vPath); //audio, video, config, images
    //setInput4Project('inputNEWPROJECT','inputNEWFILE');
    write2innerHTML("inputFILE",vFilename);
    changedOutFormat(getValueDOM(outputFORMAT));
    copyFile2Editor ("inputEDITOR",vFilename);
    //setFormat4Input();
    //write2value("inputFORMAT",)
    alert("Project: "+vName+" created!" );
  } else {
    // Do nothing!
    alert("Project Create: CANCEL Operation")
  }
}
function setFormat4Input () {
  var vInputFile = getValueDOM("inputFILE");
  var vExt = getExtensionOfFilename(vFilename);
  var vInputFormat = "markdown";
  if (vExt2Format[vExt]) {
    vInputFormat = vExt2Format[vExt];
  };
  write2value("inputFORMAT",vInputFormat);
}
function createOutputFile (pInputFile,pOutputFORMAT) {
  var vFileNoExt = removeExtension(pInputFile);
  var vExt = vExtHash[pOutputFORMAT] || pOutputFORMAT;
  return vFileNoExt+"_"+pOutputFORMAT+"."+vExt;
}
function openDirectory(pID,pDefaultPath) {
  //dialog.showOpenDialog({ properties: [ 'openFile', 'openDirectory', 'multiSelections' ]})
  var vFolder =dialog.showOpenDialog({ defaultPath: pDefaultPath , properties: [ 'openDirectory' ]});
  if (vFolder) {
    write2innerHTML(pID,vFolder);
  }
}
function openFile (pFilenameID,pTextAreaID,pPath) {
  openFileWriteDOM(pFilenameID,pTextAreaID,pPath);
};
function checkPathExists(pPath) {
  var path = require('path');
  if (path.existsSync(pPath)) {
    console.log('Found \''+pPath+'\' Path');
    // do something
  };
}
function checkFileExists(pFile) {
  if (fs.existsSync(pFile)) {
    console.log('Found \''+pFile+'\' File');
    // do something
    return true;
  } else {
    return false;
  }
}
function copyFile(pSource,pDestination) {
  if (checkFileExists(pDestination)) {
    alert("Create Error: File exists \n"+pDestination);
  } else {
    var fs = require('fs');
    fs.createReadStream(pSource).pipe(fs.createWriteStream(pDestination));
  };
};
function makedirpath(pPathDir) {
  var mkdirp = require('mkdirp');
  mkdirp(pPathDir, function(err) {
    // path exists unless there was an error
    //alert("Directory="+pPathDir+" already exists!");
  });
}
function openFileWriteDOM (pFilenameID,pTextAreaID,pDefaultPath) {
  //alert("pPath="+pPath);
  //var vDefaultPath=app.getPath('downloads')}
  //var vDefaultPath=app.getPath('documents');
  //var vSep = getPathSeparator();
  //+vSep+pPath
  var vDefaultPath = pDefaultPath || getValueDOM("projectmainDIR");
  makedirpath(vDefaultPath);
  dialog.showOpenDialog({defaultPath: vDefaultPath},function (fileNames) {
    if (fileNames === undefined) return;
    var fileName = fileNames[0];
    write2innerHTML(pFilenameID, fileName);
    changedOutFormat(getValueDOM("outputFORMAT"));
    if (pTextAreaID!="") {
      copyFile2Editor(pTextAreaID,fileName);
    };
    if (pTextAreaID=="inputEDITOR") {
      loadTitleAuthor();
      autoSelectInputFormat();
    }
 });
}
function copyFile2Editor (pID,pFilename) {
  fs.readFile(pFilename, 'utf-8', function (err, data) {
    write2value(pID, data);
    console.log('\''+pFilename+' opened!');
  });
}
function loadConfig(pConfigFile) {
  var vConfigFile = pConfigFile || "default.cfg";
  // simnply load config file into the innerHTML of DIV node 'divconfig'
  fs.readFile(__dirname+'/config/'+vConfigFile, 'utf-8', function (err, data) {
    write2innerHTML("divconfig", data);
    console.log('Config File \''+vConfigFile+' loaded!');
    write2value("inputFORMAT",getInnerHTML("selectInputFORMAT"));
    write2value("outputFORMAT",getInnerHTML("selectOutputFORMAT"));
  });
}

function saveConfig (pConfigFile) {
  var vConfigFile = pConfigFile || "default.cfg";
  // simnply write the innerHTML of DIV node 'divconfig' into file
  write2innerHTML("selectInputFORMAT",getValueDOM("inputFORMAT"));
  write2innerHTML("selectOutputFORMAT",getValueDOM("outputFORMAT"));
  var vContent=document.getElementById("divconfig").innerHTML;
  fs.writeFile('config/'+vConfigFile, vContent, (err) => {
  //fs.writeFile(vConfigFile, vContent, (err) => {
   if (err) throw err;
   console.log('Config File \''+pConfigFile+'\' saved!');
 });
}

function saveFile(pFilename,pContent) {
 fs.writeFile(pFilename, pContent, (err) => {
   if (err) throw err;
   console.log('Filename \''+pFilename+'\' saved!');
   //alert("Dirname: "+__dirname)
 });
}

function setInput4Project(pInputID,pOutputID,pExt) {
  var vPathSep = getPathSeparator(); // is on Linux/Mac "/" on Windows "Backslash"
  var vInFormat = getValueDOM("inputFORMAT");
  var vExt = vExtHash[vInFormat];
  //var vExt = pExt || vExtHash[vInFormat];
  var vDefaultFilename = "input";
  var vFilename = document.getElementById(pInputID).value || vDefaultFilename;
  if (vFilename == "") {
    alert("Error ["+pInputID+"]: Input File was undefined!\n  setInput4Project():565:index.html");
  } else {
    //alert("Format: "+vInFormat+" Extension: "+vExt);
    //if (getExtensionOfFilename(vFilename) != "md") {
    //vFilename = removeExtension(vFilename)+".md";
    //alert("Extension is not 'md'. Use filename '"+vFilename+"' instead!");
  };
  //write2value(pOutputID,vFilename);
  //alert("setInput4Project() vFilename:\n"+vFilename);
  var vProjectDir = getProjectDir();
  //alert("vProjectDir="+vProjectDir);
  vFilename = vProjectDir+vPathSep+vFilename+vPathSep+vFilename+"."+vExt;
  console.log('Set Input File: \''+vFilename+'\' to DOM-Node['+pOutputID+']!');
  write2innerHTML(pOutputID,vFilename);
}

function saveTestFile () {
  console.log("Call: saveTestFile() l.368 index.html");
  saveFile('./message.txt', 'Hello Node.js this is the File Content');
}
function saveFile2AppDir (pFilename,pContent) {
  var vSep = getPathSeparator();
  var vFilename=__dirname+vSep+pFilename;
  fs.writeFile(vFilename, pContent, (err) => {
    if (err) throw err;
    console.log('File: \''+pFilename+'\' saved to application directory!');
    //alert("Dirname: "+__dirname)
  });
}

function runShellCommand (pCommand) {
  //pCommand="ls -a";
  //alert(pCommand);
  const child = exec(pCommand,
   (error, stdout, stderr) => {
     console.log(`stdout: ${stdout}`);
     //alert(`stdout: ${stdout}`);
     if (error !== null) {
       console.log(`exec error: ${error}`);
     } else {
       console.log("'"+pCommand+"' was successful");
     }
 });
}
function convertChecker(pHash) {
  var vReturn = true;
  //alert("check input set, convertChecker()  pre command exec");
  var vInputFile = getInnerHTML("inputFILE");
  if (!vInputFile) {
    vReturn = false;
    alert("ERROR: PanDoc Input File was not defined!\n    convertChecker():656");
  } else if (vInputFile == "") {
    vReturn = false;
    alert("Error: Input File was not defined!\nCall: convertChecker():659");
  } else {
    pHash["inputFILE"] = vInputFile;
    var vExt = getExtensionOfFilename(vInputFile);
    pHash["Extension"] = vExt;
    vInputFormat = getValueDOM("inputFORMAT");
    pHash["inputFORMAT"] = vInputFormat;
    //alert("Check Format with Extension="+vExt+" inputFORMAT="+pHash["inputFORMAT"]);
    if (vExt !== vExtHash[vInputFormat]) {
      vReturn = confirm("Please check, if input Format ''"+pHash["inputFORMAT"]+"' is correct'!");
    };
    pHash["outputFORMAT"]    = getValueDOM("outputFORMAT");
    setPandocOutFormat(pHash);
  };
  console.log("convertChecker() inputFORMAT="+pHash["inputFORMAT"]);
  return vReturn;
}
function setPandocOutFormat(pHash) {
  switch (pHash["outputFORMAT"]) {
    case "docx2col":
      pHash["pandocOUTFORMAT"]="docx";
      pHash["referenceDOCX"] = getInnerHTML("refFILE"+pHash["outputFORMAT"]);
    break;
    case "odt2col":
      pHash["pandocOUTFORMAT"]="docx";
      pHash["referenceODT"] = getInnerHTML("refFILE"+pHash["outputFORMAT"]);
    break;
    default:
    //pHash["referenceODT"] = "";
    //pHash["referenceODT"] = "";
  pHash["pandocOUTFORMAT"] = getValueDOM("outputFORMAT");
  };
}
function runPandocShell(pHash) {
  saveTitleAuthor();
  pHash["inputFORMAT"] = getValueDOM("inputFORMAT");
  alert("runPandocShell(pHash) now execute "+pHash["inputFILE"]);
  executePanDocCMD(pHash);
};
function convertFile() {
  var vHash = {};
  if (convertChecker(vHash)) {
    runPandocShell(vHash);
    saveTitleAuthor();
  };
};
function saveTitleAuthor() {
  console.log("Save Title and Author");
  var vConfigFile = getFilename4TitleAuthor();
  saveFile(vConfigFile, getValueDOM("outputTITLE")+"\n"+getValueDOM("outputAUTHOR"));
};
function loadTitleAuthor() {
  console.log("Load Title and Author");
  var vConfigFile = getFilename4TitleAuthor();
  if (checkFileExists(vConfigFile)) {
    fs.readFile(vConfigFile , 'utf-8', function (err, data) {
      // check if the cfg-File with Title and Author exists
      if (data) {
        var vLines = data.split("\n");
        write2value("outputTITLE",vLines[0]);
        write2value("outputAUTHOR",vLines[1]);
        console.log('Config File \''+vConfigFile +' opened!');
      }
    });
  } else {
    console.log('Config File \''+vConfigFile +' does not exist!');
  }
}
function getFilename4TitleAuthor() {
  var vFilename = getInnerHTML("inputFILE");
  //alert("vFilename="+vFilename+"\n getFilename4TitleAuthor()");
  var vPath = getPathFromFilename(vFilename);
  var vName = getName4Filename(vFilename);
  var vSep = getPathSeparator();
  var vConfigFile = vPath+vSep+"config"+vSep+vName+".cfg";
  console.log("getFilename4TitleAuthor() vConfigFile=+"+vConfigFile);
  return vConfigFile;
}
var vHashTPL = new Array();

function appendDirectoryInput(pID,pTitle,pTemplate,pFolderID,pPathDefault,pButtonTitle) {
  var vReplaceHash = {};
  vReplaceHash["FOLDERID"]    = pFolderID;
  vReplaceHash["BUTTONTITLE"] = pButtonTitle;
  vReplaceHash["TITLE"] = pTitle;
  vReplaceHash["PATHDEFAULT"] = pPathDefault;
  appendTemplateHash(pID,pTemplate,vReplaceHash);
};
function appendTemplateInput(pID,pOutputFORMAT,pTemplate,pPath,pExt) {
  var vReplaceHash = {};
  var vSep = getPathSeparator();
  var vDefaultName = "tpldefault";
  if ((pOutputFORMAT=="odt") && (pTemplate.indexOf("referencefile")>0)) {
    vDefaultName = "content"
  };
  if (pExt=="md") {
    vDefaultName = "input"
  };
  vReplaceHash["FORMAT"] = pOutputFORMAT;
  vReplaceHash["TYPE"]   = pOutputFORMAT.toUpperCase();
  vReplaceHash["TPLDEFAULT"] = pPath+vSep+"tpl"+vSep+pOutputFORMAT+vSep+vDefaultName+"."+pExt;
  appendTemplateHash(pID,pTemplate,vReplaceHash);
};
function appendTemplateHash(pID,pTemplate,pReplaceHash) {
  var vContent = "Error: Template "+pTemplate+" undefined";
  if (vHashTPL[pTemplate]) {
  //  vContent = vHashTPL[pTemplate];
    alert("Template: "+pTemplate+" exists\n"+vHashTPL[pTemplate]);
  };
  //} else {
  fs.readFile(pTemplate, 'utf-8', function (err, tpldata) {
      //alert("Template: "+pTemplate+" load\n"+tpldata);
      vContent = tpldata;
      for (iID in pReplaceHash) {
        vContent = replaceString(vContent,"___"+iID+"___", pReplaceHash[iID]);
      };
      //alert("REPLACED ["+pID+"]: \n"+vContent);
      append2innerHTML(pID,vContent);
      console.log('Template File \''+pTemplate+' loaded!');
  });
};
function setInput4WebDownload() {
  var vSep = getPathSeparator();
  var vProjectName = document.getElementById("inputPROJECT").value;
  var vDownloadFile = getProjectDir()+vSep+vProjectName+vSep+vProjectName+"_web.md";
  document.getElementById("downloadWebFILE").innerHTML = vDownloadFile;
}
function setDefaultValues() {
  var vPathSeparator = getPathSeparator(); // is on Linux/Mac "/" on Windows "Backslash"
  var vPathMain = app.getPath('documents')+vPathSeparator+"PanDoc";
  write2innerHTML("projectmainDIR",vPathMain);
  //setInput4WebDownload();
  setInput4Project('inputNEWPROJECT','inputNEWFILE');
  setInput4Project('inputWEBPROJECT','downloadWebFILE',"md");
  // set vPath to Template Path and init the templates to default filenames
  //var vPath = app.getPath('documents')+vPathSeparator+"PanDoc";
  var vPath = __dirname;
  //var vPath = app.getPath('home')+vPathSeparator+"ownCloudLD"+vPathSeparator+"PanDoc";

  var vhtml ="html"+vPathSeparator;
  appendTemplateInput("tabletemplates","DEFAULT",vhtml+'template.html',vPath,"md");
  appendTemplateInput("tabletemplates","reveal",vhtml+'template.html',vPath,"html");
  appendTemplateInput("tabletemplates","audioslides",vhtml+'template.html',vPath,"html");
  appendTemplateInput("tabletemplates","latex",vhtml+'template.html',vPath,"tex");
  appendTemplateInput("tabletemplates","odt",vhtml+'template.html',vPath,"xml");
  appendTemplateInput("tabletemplates","odt",vhtml+'referencefile.html',vPath,"odt");
  appendTemplateInput("tabletemplates","odt2col",vhtml+'referencefile.html',vPath,"odt");
  appendTemplateInput("tabletemplates","docx",vhtml+'referencefile.html',vPath,"docx");
  appendTemplateInput("tabletemplates","docx2col",vhtml+'referencefile.html',vPath,"docx");
  //alert(app.getPath('documents'))
  appendDirectoryInput("tablefolders","Reveal",vhtml+"defaultfolder.html","reveal",vPathMain+vPathSeparator+"reveal","Reveal Folder ");
  appendDirectoryInput("tablefolders","MathJax",vhtml+"defaultfolder.html","mathjax",vPathMain+vPathSeparator+"mathjax","MathJax Folder ");

  setColorSelected("bConvert");
}

vExtHash={};
vExtHash["pdf"]="pdf"; //audioslides
vExtHash["html"]="html";
vExtHash["html5"]="html";
vExtHash["reveal"]="html";
vExtHash["dzslides"]="html";
vExtHash["audioslides"]="html";
vExtHash["mediawiki"]="wiki";
vExtHash["latex"] = "tex";
vExtHash["markdown"] = "md";
vExtHash["beamer"] = "tex";
vExtHash["odt"] = "odt";
vExtHash["docx"] = "docx";
vExtHash["odt2col"] = "odt";
vExtHash["docx2col"] = "docx";
vExtHash["asciidoc"] = "asciidoc";
vExtHash["context"] = "tex";
vExtHash["docbook"] = "db";
vExtHash["dokuwiki"] = "wiki";
vExtHash["man"] = "man";
vExtHash["icml"] = "icml";
vExtHash["markdown_strict"] = "mds";
vExtHash["markdown_phpextra"] = "mdphp";
vExtHash["markdown_github"] = "mdgit";
vExtHash["markdown_mmd"] = "mmd";
vExtHash["haddock"] = "had"
vExtHash["rst"] = "rst";
vExtHash["textile"] = "textile";
vExtHash["org"] = "org";
vExtHash["opendocument"] = "xml";
vExtHash["opml"] = "opml";
vExtHash["rtf"] = "rtf";
vExtHash["S5"] = "s5";
vExtHash["slideous"] = "html";
vExtHash["slidy"] = "html";
vExtHash["texinfo"] = "texi";
//alert("vExtHash[markdown]="+vExtHash["markdown"]);

vExt2Format={};
for (iID in vExtHash) {
  vExt2Format[vExtHash[iID]]=iID;
};
vExt2Format["html"]="html";
//vExt2Format["pdf"]="audioslides";
vExt2Format["tex"]="latex";
vExt2Format["wiki"]="mediawiki";

setDefaultValues();

</script>

  </body>

  <script>
    // You can also require other files to run in this process
    require('./renderer.js')
    //const fs = require('fs');
    const exec = require('child_process').exec;
  </script>
</html>
