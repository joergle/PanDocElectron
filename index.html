<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>PanDoc Electron</title>
    <!-- script src="./js/jquery-1.js"></script>
    <script src="./js/bootstrap.js"></script -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <script src="js/showhide.js"></script>
    <script src="js/pathfiles.js"></script>
    <script src="js/writedom.js"></script>

  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <h1><a href="http://pandoc.org/try" target="_blank">PanDoc</a> Electron</h1>
        </div>
        <div class="col-md-6">
          <pre id="command"></pre>
        </div>
      </div>
      <div class="row">
        <div align="center">
          <button  id="loadConfig"  onclick="loadConfig('default.cfg');">Load Config</button>
          <button  id="saveConfig"  onclick="saveConfig('default.cfg');">Save Config</button>
          <button class="btn btn-primary btn-xs"  id="convertFILE"  onclick="convertFile();" >Convert File</button>
          <hr/>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6" id="divconfig">
          <table border="0"  cellspacing="30" class="buttonsnovice">
            <tr>
              <td>
                <b id="projectmainLABEL">Main Folder:</b>
              </td>
              <td>
                  &nbsp;
              </td>
              <td>
                  <input type="text" size="55" id="projectmainDIR" value="">
              </td>
            </tr>
            <tr>
              <td>
                <button class="btn btn-primary btn-xs"  id="openFile"  onclick="openInputFile('projects');">Input File</button>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <select id="inputFORMAT">
                  <option value="docbook">DocBook</option>
                  <option value="haddock">Haddock markup</option>
                  <option value="html">HTML</option>
                  <option value="latex">LaTeX</option>
                  <option value="markdown" selected="selected">Markdown (pandoc)</option>
                  <option value="markdown_strict">Markdown (strict)</option>
                  <option value="markdown_phpextra">Markdown (PHP Markdown Extra)</option>
                  <option value="markdown_github">Markdown (GitHub)</option>
                  <option value="mediawiki">MediaWiki</option>
                  <option value="markdown_mmd">MultiMarkdown</option>
                  <option value="opml">OPML</option>
                  <option value="org">Org Mode</option>
                  <option value="rst">reStructuredText</option>
                  <option value="textile">Textile</option>
                  <option value="t2t">Txt2Tags</option>
                </select>
              </td>
            </tr>
            <tr>
              <td align="right">
                <b>Input File:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="inputFILE"></tt>
              </td>
            </tr>
            <tr><!-- outputFILE -->
              <td align="right">
                <b>Output Format:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <select id="outputFORMAT" onchange="changedOutFormat(this.value)">
                  <option value="html">HTML</option>
                  <option value="html5">HTML 5</option>
                  <option value="latex">LaTeX</option>
                  <option value="markdown">Markdown (pandoc)</option>
                  <option value="mediawiki">MediaWiki</option>
                  <option value="beamer">LaTeX Beamer</option>
                  <option value="reveal" selected="selected">RevealJS</option>
                  <option value="audioslides">AudioSlides</option>
                  <option value="dzslides">DZSlides</option>
                  <option value="odt">ODT-File</option>
                  <option value="docx">DOCX-File</option>
                  <option value="asciidoc">AsciiDoc</option>
                  <option value="context">ConTeXt</option>
                  <option value="docbook">DocBook</option>
                  <option value="dokuwiki">DokuWiki</option>
                  <option value="man">Groff man</option>
                  <option value="icml">ICML</option>
                  <option value="markdown_strict">Markdown (strict)</option>
                  <option value="markdown_phpextra">Markdown (PHP Markdown Extra)</option>
                  <option value="markdown_github">Markdown (GitHub)</option>
                  <option value="markdown_mmd">MultiMarkdown</option>
                  <option value="rst">reStructuredText</option>
                  <option value="textile">Textile</option>
                  <option value="org">Org Mode</option>
                  <option value="opendocument">OpenDocument</option>
                  <option value="opml">OPML</option>
                  <option value="rtf">RTF</option>
                  <option value="S5">S5</option>
                  <option value="slideous">Slideous</option>
                  <option value="slidy">Slidy</option>
                  <option value="texinfo">Texinfo</option>
                </select>
              </td>
            </tr>
            <tr><!-- outputFILE -->
              <td align="right">
                <b>Output File:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="outputFILE"></tt>
              </td>
            </tr>
          </table>
          <hr/>
          <h3>
            Web-Input:
            <input type="checkbox" name="checkWebInput" id="checkWebInput" onclick="toggleCheck('tableweb',this.checked)" >
          </h3>
          <table border="0"  cellspacing="30" id="tableweb" class="buttonsweb"  hidden="hidden">
            <tr>
              <td align="right">
                <b>Project Name:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <input type="text" size="35" id="inputPROJECT" value="mywebfile" onchange="setInput4WebDownload()">
              </td>
            </tr>
            <tr>
              <td align="right">
                <b>Download File:</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="downloadWebFILE"></tt>
              </td>
            </tr>
            <tr>
              <td align="right">
                <button class="btn btn-primary btn-xs"  id="downloadFile"  onclick="downloadInputFile('projects');">Download File</button>
              </td>
              <td>
                  &nbsp;
              </td>
              <td>
                  <input type="text" size="55" id="inputURL" value="http://www.gnu.org/software/make/" >
              </td>
            </tr>
          </table>
          <hr/>
          <h3>
            Bibiography:
            <input type="checkbox" name="checkCitation" id="checkCitation" onclick="toggleCheck('tablecitation',this.checked)" >
          </h3>
          <table border="0"  cellspacing="30" id="tablecitation" class="buttonscitation"  hidden="hidden">
            <tr><!-- bibFILE -->
              <td>
                  <button class="btn btn-primary btn-xs"  id="openBIBFile"  onclick="openBIBFile('bib/data');">BibTeX Citation</button>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt>BibTeX-Format</tt>
              </td>
            </tr>
            <tr><!-- bibFILE -->
              <td>
                <b>&nbsp;</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="bibFILE"></tt>
              </td>
            </tr>
            <tr><!-- cslFILE -->
              <td>
                <button class="btn btn-primary btn-xs"  id="openCSLFile"  onclick="openCSLFile('bib/data');">CSL-File</button>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt>Citation Style</tt>
              </td>
            </tr>
            <tr><!-- cslFILE -->
              <td>
                <b>&nbsp;</b>
              </td>
              <td>
                &nbsp;
              </td>
              <td>
                <tt id="cslFILE"></tt>
              </td>
            </tr>
          </table>
          <hr/>
          <h3>
            Templates:
            <input type="checkbox" name="checkTemplates" id="checkTemplates" onclick="toggleCheck('tabletemplates',this.checked)" >
          </h3>
          <table border="0"  cellspacing="30" id="tabletemplates" class="buttonstemplate"  hidden="hidden">
          </table>
          <hr/>
          <h3>
            Reveal and MathJax:
            <input type="checkbox" name="checkReveal" id="checkReveal" onclick="toggleCheck('tablereveal',this.checked)" >
          </h3>
          <table border="0"  cellspacing="30" id="tablereveal" class="buttonstemplate"  hidden="hidden">
          </table>
          <hr/>
          <h3>
            Input Editor:
            <input type="checkbox" name="checkEditor" id="checkEditor" onclick="toggleCheck('inputEDITOR',this.checked)" >
          </h3>
          <textarea id="inputEDITOR" maxlength="3000" rows="15" hidden="hidden"></textarea>
          <hr/>
        </div>
    </div>
    <footer>
     <p class="version">PanDoc Electron - GUI <span id="version">0.4</span> - Engelbert Niehaus</p>
     <p>for PanDoc by <a href="http://johnmacfarlane.net/" target="_blank">John MacFarlane</a>
       PanDoc Electron uses Node.js <script>document.write(process.versions.node)</script>,
       Chromium <script>document.write(process.versions.chrome)</script>,
       and Electron <script>document.write(process.versions.electron)</script>.
     </p>
    </footer>
    <!-- All of the Node.js APIs are available in this renderer process. -->
<br />
<script>
var remote  = require('remote');
const fs    = require('fs');
var app     = remote.require('app');
var dialog  = remote.require('dialog');
var vExtHash = new Array();
vExtHash["latex"]="tex";
vExtHash["beamer"]="tex";
vExtHash["mediawiki"]="wiki";
vExtHash["reveal"]="html";
vExtHash["markdown"]="html";
vExtHash["dzslides"]="html";
vExtHash["audioslides"]="html";

function openInputFile (pPath) {
  pPath = getProjectDir(pPath);
  openFile("inputFILE","inputEDITOR",pPath)
}
function openBIBFile (pPath) {
  pPath = getProjectDir(pPath);
  openFile("bibFILE","",pPath)
}
function openREFFile (pPath) {
  pPath = getProjectDir(pPath);
  openFile("refFILE","",pPath)
}
function openCSLFile (pPath) {
  pPath = getProjectDir(pPath);
  openFile("cslFILE","",pPath)
}
function openTPLFile (pPath) {
  pPath = getProjectDir(pPath);
  openFile("tplFILE","",pPath)
}
function downloadInputFile(pPath) {
  alert("Download Input File and Convert Source File to MarkDown");
};
function changedWebInput(pChecked) {
  //alert("Changed Web Input");
  if (pChecked) {
    showElement("labelURL");
    showElement("inputURL");
    showElement("webProjectName");
  } else {
    hideElement("labelURL");
    hideElement("inputURL");
    hideElement("webProjectName");
  }
};
function changedOutFormat (pOutputFORMAT) {
  if ((pOutputFORMAT=="odt") || (pOutputFORMAT=="docx")) {
    showElement("labelREFFile")
    showElement("refLABEL")
    showElement("refFILE")
  } else {
    hideElement("labelREFFile")
    hideElement("refLABEL")
    hideElement("refFILE")
  }
}

function createOutputFile (pInputFile,pOutputFORMAT) {
  var vFileNoExt = removeExtension(pInputFile);
  var vExt = vExtHash[pOutputFORMAT] || pOutputFORMAT;
  return vFileNoExt+"_"+pOutputFORMAT+"."+vExt;
}
function openDirectory(pID,pDefaultPath) {
  //dialog.showOpenDialog({ properties: [ 'openFile', 'openDirectory', 'multiSelections' ]})
  dialog.showOpenDialog({ defaultPath: pDefaultPath , properties: [ 'openDirectory' ]})
}
function openFile (pFilenameID,pTextAreaID,pPath) {
  openFileWriteDOM(pFilenameID,pTextAreaID,pPath,write2value);
};
function checkPathExists(pPath) {
  var path = require('path');
  if (path.existsSync(pPath)) {
    console.log('Found \''+pPath+'\' Path');
    // do something
  };
}
function checkFileExists(pFile) {
  if (fs.existsSync(pFile)) {
    console.log('Found \''+pFile+'\' File');
    // do something
  }
}
function openFileWriteDOM (pFilenameID,pTextAreaID,pPath,fWriteDOM) {
  var mkdirp = require('mkdirp');
  //alert("pPath="+pPath);
  var vNode = document.getElementById("projectmainDIR");
  //var vDefaultPath=app.getPath('downloads')}
  var vDefaultPath=app.getPath('documents')
  if (vNode) {
    alert("Project Main Dir:"+vNode.value);
    vDefaultPath=vNode.value;
  }
  mkdirp(vDefaultPath, function(err) {
    // path exists unless there was an error
    //alert("vDefaultPath="+vDefaultPath+" is existing");
  });
  dialog.showOpenDialog({defaultPath: vDefaultPath},function (fileNames) {
  if (fileNames === undefined) return;
  var fileName = fileNames[0];
  write2innerHTML(pFilenameID, fileName);
  if (pTextAreaID!="") {
    fs.readFile(fileName, 'utf-8', function (err, data) {
      write2value(pTextAreaID, data);
      console.log('\''+fileName+' opened!');
    });
  };
 });
}

function loadConfig(pConfigFile) {
  var vConfigFile = pConfigFile || "default.cfg";
  // simnply load config file into the innerHTML of DIV node 'divconfig'
  fs.readFile(__dirname+'/config/'+vConfigFile, 'utf-8', function (err, data) {
    write2innerHTML("divconfig", data);
    console.log('Config File \''+vConfigFile+' loaded!');
  });

}

function saveConfig (pConfigFile) {
  var vConfigFile = pConfigFile || "default.cfg";
  // simnply write the innerHTML of DIV node 'divconfig' into file
  var vContent=document.getElementById("divconfig").innerHTML;
  fs.writeFile('config/'+vConfigFile, vContent, (err) => {
  //fs.writeFile(vConfigFile, vContent, (err) => {
   if (err) throw err;
   console.log('Config File \''+pConfigFile+'\' saved!');
 });
}

function saveFile(pFilename,pContent) {
 fs.writeFile(pFilename, pContent, (err) => {
   if (err) throw err;
   console.log('Filename \''+pFilename+'\' saved!');
   //alert("Dirname: "+__dirname)
 });
}

function setInput4WebDownload() {
  var vFilename = document.getElementById("inputWEBFILE").value || "webdownload.md";

  if (vFilename == "") {
    alert("Download File undefined, set Filename to 'webdownload.md'")
  } else if (getExtensionOfFilename(vFilename) != "md") {
    vFilename = removeExtension(vFilename)+".md";
    alert("Extension is not 'md'. Use filename '"+vFilename+"' instead!");
  };
  write2value("inputWEBFILE",vFilename);
  vFilename = getProjectDir(pProject)+"/"+vFilename;
  console.log('Web Input File: \''+vFilename+'\' defined!');
  write2innerHTML("inputFILE",vFilename);
}

function saveTestFile () {
  alert("Call: saveTestFile() l.368 index.html")
  saveFile('./message.txt', 'Hello Node.js this is the File Content');
}
function saveFile2AppDir (pFilename,pContent) {
  var vFilename=__dirname+"/"+pFilename;
  fs.writeFile(vFilename, pContent, (err) => {
    if (err) throw err;
    console.log('File: \''+vFilename+'\' saved!');
    //alert("Dirname: "+__dirname)
  });
}

function runShellCommand (pCommand) {
 const child = exec(pCommand,
   (error, stdout, stderr) => {
     console.log(`stdout: ${stdout}`);
     //alert(`stdout: ${stdout}`);
     console.log(`stderr: ${stderr}`);
     if (error !== null) {
       console.log(`exec error: ${error}`);
     }
 });
}
function convertChecker() {
  alert("check input set, webdownload command exec");
}
function runPandocShell() {
  alert("now execute ");
}
function convertFile() {
  convertChecker();
  runPandocShell();
};

var vHashTPL = new Array();

function appendDirectoryInput(pID,pTitle,pTemplate,pFolderID,pPathDefault,pButtonTitle) {
  var vReplaceHash = {};
  vReplaceHash["FOLDERID"]    = pFolderID;
  vReplaceHash["BUTTONTITLE"] = pButtonTitle;
  vReplaceHash["TITLE"] = pTitle;
  vReplaceHash["PATHDEFAULT"] = pPathDefault;
  appendTemplateHash(pID,pTemplate,vReplaceHash);
};
function appendTemplateInput(pID,pOutputFORMAT,pTemplate,pPath,pExt) {
  var vReplaceHash = {};
  var vDefaultName = "tpldefault";
  if ((pOutputFORMAT=="odt") && (pTemplate.indexOf("referencefile")>0)) {
    vDefaultName = "content"
  };
  vReplaceHash["FORMAT"] = pOutputFORMAT;
  vReplaceHash["TYPE"]   = pOutputFORMAT.toUpperCase();
  vReplaceHash["TPLDEFAULT"] = pPath+"/tpl/"+pOutputFORMAT+"/"+vDefaultName+"."+pExt;
  appendTemplateHash(pID,pTemplate,vReplaceHash);
};
function appendTemplateHash(pID,pTemplate,pReplaceHash) {
  var vContent = "Error: Template "+pTemplate+" undefined";
  if (vHashTPL[pTemplate]) {
  //  vContent = vHashTPL[pTemplate];
    alert("Template: "+pTemplate+" exists\n"+vHashTPL[pTemplate]);
  };
  //} else {
  fs.readFile(pTemplate, 'utf-8', function (err, tpldata) {
      //alert("Template: "+pTemplate+" load\n"+tpldata);
      vContent = tpldata;
      for (iID in pReplaceHash) {
        vContent = replaceString(vContent,"___"+iID+"___", pReplaceHash[iID]);
      };
      //alert("REPLACED ["+pID+"]: \n"+vContent);
      append2innerHTML(pID,vContent);
      console.log('Template File \''+pTemplate+' loaded!');
  });
};
function setInput4WebDownload() {
  var vProjectName = document.getElementById("inputPROJECT").value;
  var vDownloadFile = getProjectDir()+"/"+vProjectName+"/"+vProjectName+"_web.md";
  document.getElementById("downloadWebFILE").innerHTML = vDownloadFile;
}
function setDefaultValues() {
  var vPathMain = app.getPath('documents')+"/PanDoc";
  write2value("projectmainDIR",vPathMain);
  setInput4WebDownload();
  // set vPath to Template Path and init the templates to default filenames
  var vPath = app.getPath('home')+"/ownCloudLD/PanDoc";
  appendTemplateInput("tabletemplates","reveal",'html/template.html',vPath,"html");
  appendTemplateInput("tabletemplates","audioslides",'html/template.html',vPath,"html");
  appendTemplateInput("tabletemplates","odt",'html/template.html',vPath,"xml");
  appendTemplateInput("tabletemplates","odt",'html/referencefile.html',vPath,"odt");
  appendTemplateInput("tabletemplates","docx",'html/referencefile.html',vPath,"docx");
  appendTemplateInput("tabletemplates","latex",'html/template.html',vPath,"tex");
  //alert(app.getPath('documents'))
  appendDirectoryInput("tablereveal","Reveal","html/defaultfolder.html","reveal",vPathMain+"/reveal","Reveal Folder ");
  appendDirectoryInput("tablereveal","MathJax","html/defaultfolder.html","mathjax",vPathMain+"/mathjax","MathJax Folder ");
}

setDefaultValues();

</script>

  </body>

  <script>
    // You can also require other files to run in this process
    require('./renderer.js')
    //const fs = require('fs');
    const exec = require('child_process').exec;
  </script>
</html>
